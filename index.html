<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VGGLuck | AI Music Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #00ff41; --bg: #050505; --card: #121212; }
        body {
            background: var(--bg); color: white; font-family: 'Dela Gothic One', cursive;
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
        }
        .container { max-width: 600px; width: 100%; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #222; text-align: center; }
        h1 { color: var(--green); text-shadow: 0 0 10px var(--green); }
        textarea {
            width: 100%; background: #000; border: 1px solid var(--green); color: #fff;
            padding: 15px; border-radius: 12px; font-family: inherit; margin-bottom: 20px; outline: none; box-sizing: border-box;
        }
        .vgg-btn {
            background: var(--green); color: #000; border: none; width: 100%;
            padding: 18px; border-radius: 40px; font-family: inherit; font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .vgg-btn:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--green); }
        .vgg-btn:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }
        
        /* –°—Ç–∏–ª–∏ –ø–ª–µ–µ—Ä–∞ */
        #result-area { margin-top: 30px; display: none; background: #1a1a1a; padding: 20px; border-radius: 15px; }
        audio { width: 100%; margin-bottom: 15px; filter: invert(100%) hue-rotate(90deg) brightness(1.5); }
        .download-link {
            color: var(--green); text-decoration: none; border: 1px solid var(--green);
            padding: 10px 20px; border-radius: 20px; display: inline-block; font-size: 14px; transition: 0.3s;
        }
        .download-link:hover { background: var(--green); color: #000; }
        #status { color: #888; font-size: 12px; margin-top: 15px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <h1>VGGLUCK AI</h1>
    <textarea id="prompt" rows="3" placeholder="–ù–∞–ø—Ä: Heavy Phonk, Dark Bass, 120 BPM..."></textarea>
    <button id="genBtn" class="vgg-btn">GENERATE TRACK</button>
    <div id="status"></div>

    <div id="result-area">
        <h3 style="margin-top:0">YOUR TRACK IS READY</h3>
        <audio id="audioPlayer" controls></audio>
        <br>
        <a id="downloadBtn" class="download-link" download="vggluck_track.wav">üì• DOWNLOAD .WAV</a>
    </div>
</div>

<script type="module">
    // –§–ò–ö–° –û–®–ò–ë–ö–ò: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Å–∏—é 2.17.2, –≥–¥–µ MusicGen —Å—Ç–∞–±–∏–ª–µ–Ω
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    env.allowLocalModels = false;
    env.useBrowserCache = true;

    const genBtn = document.getElementById('genBtn');
    const status = document.getElementById('status');
    const resultArea = document.getElementById('result-area');
    const audioPlayer = document.getElementById('audioPlayer');
    const downloadBtn = document.getElementById('downloadBtn');

    let synthesizer = null;

    genBtn.onclick = async () => {
        const text = document.getElementById('prompt').value;
        if (!text) return alert("–ü—Ä–æ–º–ø—Ç –ø—É—Å—Ç–æ–π!");

        genBtn.disabled = true;
        resultArea.style.display = 'none';
        status.innerHTML = "‚åõ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ò...<br><span style='font-size:10px'>(–≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∫–∞—á–∞–µ—Ç—Å—è ~300–ú–ë)</span>";

        try {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ (–±–µ–∑ Unsupported model type)
            if (!synthesizer) {
                synthesizer = await pipeline('text-to-audio', 'Xenova/musicgen-small');
            }

            status.innerText = "üéµ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–£–ó–´–ö–ò... (—ç—Ç–æ –∑–∞–π–º–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã)";
            
            const output = await synthesizer(text, {
                max_new_tokens: 256, // ~5-7 —Å–µ–∫—É–Ω–¥ –∞—É–¥–∏–æ
                do_sample: true
            });

            // –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í WAV
            // output.audio - —ç—Ç–æ Float32Array. –ë—Ä–∞—É–∑–µ—Ä—É –Ω—É–∂–µ–Ω Blob.
            const audioBlob = makeWavBlob(output.audio, output.sampling_rate);
            const audioUrl = URL.createObjectURL(audioBlob);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–µ—Ä–∞ –∏ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            audioPlayer.src = audioUrl;
            downloadBtn.href = audioUrl;
            
            status.innerText = "‚úÖ –ì–û–¢–û–í–û!";
            resultArea.style.display = 'block';
            audioPlayer.play();

        } catch (e) {
            console.error(e);
            status.innerText = "‚ùå –û–®–ò–ë–ö–ê: " + e.message;
        }
        genBtn.disabled = false;
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ WAV —Ñ–∞–π–ª–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–∏
    function makeWavBlob(audioData, samplingRate) {
        const buffer = new ArrayBuffer(44 + audioData.length * 2);
        const view = new DataView(buffer);

        const writeString = (offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        writeString(0, 'RIFF');
        view.setUint32(4, 32 + audioData.length * 2, true);
        writeString(8, 'WAVE');
        writeString(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true);
        view.setUint32(24, samplingRate, true);
        view.setUint32(28, samplingRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        writeString(36, 'data');
        view.setUint32(40, audioData.length * 2, true);

        let offset = 44;
        for (let i = 0; i < audioData.length; i++) {
            const s = Math.max(-1, Math.min(1, audioData[i]));
            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            offset += 2;
        }

        return new Blob([buffer], { type: 'audio/wav' });
    }
</script>
</body>
</html>
